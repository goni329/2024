<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voters</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.7.1.min.js"></script>

</head>
<body>
  <div id="container">
		<!-- header -->
    <header id="header">
			<nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">&nbsp;VOTERS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link me-4" href="#container-1">공약보기</a>
                    <a class="nav-link me-4" href="#vote">투표하기</a>
                    <a class="nav-link me-4" href="#findBooth">투표소찾기</a>
                    <a class="nav-link me-4" href="#voteCount">개표현황</a>
										<button type="button" class="btn btn-outline-primary login-btn" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="bi bi-person me-1"></i>로그인</button>
                </div>
            </div>
        </div>
    </nav>
    </header>
		<!-- main -->
    <main id="main">
			<!-- 공약보기 -->
			<div id="container-1">
				<div id="carouselExampleIndicators" class="carousel slide">
					<div class="carousel-indicators">
						<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
						<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
						<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
						<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4"></button>
					</div>
					<div class="carousel-inner">
						<div class="carousel-item active">
							<img src="./img/cat.jpg" class="d-block w-100" alt="...">
						</div>
						<div class="carousel-item">
							<img src="./img/dog.jpg" class="d-block w-100" alt="...">
						</div>
						<div class="carousel-item">
							<img src="./img/chipmunk.jpg" class="d-block w-100" alt="...">
						</div>
						<div class="carousel-item">
							<img src="./img/rabbit.jpg" class="d-block w-100" alt="...">
						</div>
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Previous</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Next</span>
					</button>
				</div>
			</div>

			<!-- 투표하기 -->
			<div id="vote">
				<h5>투표하기</h5>
				<div class="card">
					<div class="card-img">
						<img class="cat" src="./img/v_cat.jpg" alt="">
					</div>
					<div class="card-bottom">
						<h5>1번 고양이</h5>
						<span>츄르당</span>
						<button class="btn btn-primary" onclick="voteForCandidate('고양이')">'고양이' 투표하기</button>
					</div>
				</div>

				<div class="card">
					<div class="card-img">
						<img class="dog" src="./img/v_dog.jpg" alt="">
					</div>
					<div class="card-bottom">
						<h5>2번 강아지</h5>
						<span>멍멍당</span>
						<button class="btn btn-primary" onclick="voteForCandidate('강아지')">'강아지' 투표하기</button>
					</div>
				</div>

				<div class="card">
					<div class="card-img">
						<img class="chipmunk" src="./img/v_chipmunk.jpg" alt="">
					</div>
					<div class="card-bottom">
						<h5>3번 다람쥐</h5>
						<span>도토리당</span>
						<button class="btn btn-primary" onclick="voteForCandidate('다람쥐')">'다람쥐' 투표하기</button>
					</div>
				</div>

				<div class="card">
					<div class="card-img">
						<img class="rabbit" src="./img/v_rabbit.jpg" alt="">
					</div>
					<div class="card-bottom">
						<h5>4번 토끼</h5>
						<span>당근당</span>
						<button class="btn btn-primary" onclick="voteForCandidate('토끼')">'토끼' 투표하기</button>
					</div>
				</div>
			</div>

			<!-- 투표소찾기 -->
			<div id="findBooth">
				<h5>투표소찾기 (종로구)</h5>
				<div id="map" style="width:1204px;height:500px;margin: 0 109.5px;"></div>
			</div>

			<!-- 개표현황 -->
			<div id="voteCount">
				<h5>개표 현황</h5>
				<div id="chart_div"></div>
			</div>
    </main>

		<!-- footer -->
    <footer id="footer">
			<div class="footer-logo">
				<h2>VOTERS</h2>
				<p>&copy;2024 eun All rights reserved</p>
				<div class="sns">
					<i class="bi bi-instagram bi-large">&nbsp;<a href="https://www.instagram.com/enueunue/">enueunue</a></i>
				</div>
			</div>
		</footer>
  </div>

	<!-- Modal -->
	<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel"><i class="bi bi-person me-1"></i>로그인</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- id -->
					<div class="form-floating mb-3">
						<input type="exampleInputUsername" class="form-control" id="floatingInput" placeholder="id">
						<label for="floatingInput">아이디</label>
					</div>
					<!-- pw -->
					<div class="form-floating">
						<input type="password" class="form-control" id="floatingPassword" placeholder="Password">
						<label for="floatingPassword">비밀번호</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
					<button type="button" class="btn btn-primary">로그인</button>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=bf8cfd9a56152bcd9c7a16275827b254"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script>

	//투표하기
	// 블록체인 생성
	let voteBlockchain = createBlockchain();

	// 투표 버튼 클릭 이벤트 
	function voteForCandidate(candidate) {
		alert("'" + candidate + "'에게 투표 완료");
		addVote(`Voter${voteBlockchain.chain.length}`, candidate);
		drawChart(); // 투표 할때마다 차트에 반영
	}

	// 투표 추가
	function addVote(voter, candidate) {
		let newBlock = createBlock(voteBlockchain.chain.length, Date.now(), { voter: voter, candidate: candidate });
		voteBlockchain.addBlock(newBlock);
	}

	// 블록 생성
	function createBlock(index, timestamp, data, previousHash = '') {
		return {
			index: index,
			timestamp: timestamp,
			data: data,
			previousHash: previousHash,
			nonce: 0,
			hash: calculateHash(index, timestamp, data, previousHash, 0)
		};
	}

	// 블록 해시 값 계산
	function calculateHash(index, timestamp, data, previousHash, nonce) {
		return CryptoJS.SHA256(index + previousHash + timestamp + JSON.stringify(data) + nonce).toString();
	}

	// 처음 빈 블록 생성
	function createEmptyBlock() {
		return createBlock(0, "01/01/2024", "Empty Block", "0");
	}

	// 블록체인 객체 생성
	function createBlockchain() {
		return {
			chain: [createEmptyBlock()],
			difficulty: 4, // 마이닝 난이도
			getLatestBlock: function () {
				return this.chain[this.chain.length - 1];
			},
			addBlock: function (newBlock) {
				newBlock.previousHash = this.getLatestBlock().hash;
				mineBlock(newBlock, this.difficulty);
				this.chain.push(newBlock);
			},
			isChainValid: function () {
				for (let i = 1; i < this.chain.length; i++) {
					const currentBlock = this.chain[i];
					const previousBlock = this.chain[i - 1];
					if (currentBlock.hash !== calculateHash(currentBlock.index, currentBlock.timestamp, currentBlock.data, currentBlock.previousHash, currentBlock.nonce)) {
							return false;
					}
					if (currentBlock.previousHash !== previousBlock.hash) {
							return false;
					}
					}
					return true;
			}
		};
	}

	// 블록 마이닝
	function mineBlock(block, difficulty) {
		while (block.hash.substring(0, difficulty) !== Array(difficulty + 1).join("0")) {
			block.nonce++;
			block.hash = calculateHash(block.index, block.timestamp, block.data, block.previousHash, block.nonce);
		}
		// console.log("Block mined: " + block.hash);
	}

	// 개표
	function result() {
		let voteCount = {};
			
			voteBlockchain.chain.forEach(block => {
				if (block.data.candidate) {
					const candidate = block.data.candidate;
					if (!voteCount[candidate]) {
							voteCount[candidate] = 1;
					} else {
							voteCount[candidate]++;
					}
				}
			});
			
			return Object.entries(voteCount).map(([candidate, votes]) => [candidate, votes]);
	}

	//------------------------------------------------------------------------------------------------------------------------------

		//근처 투표소 찾기
		let mapContainer = document.getElementById('map'), // 지도를 표시할 div  
    mapOption = { 
			center: new kakao.maps.LatLng(37.5796, 126.9911), // 지도의 중심좌표
			level: 7 // 지도의 확대 레벨
    };

		let map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
 
		// 마커를 표시할 위치와 내용을 가지고 있는 객체 배열입니다 
		let positions = [
			{
					content: '<div>청운효자동사전투표소</div>', 
					latlng: new kakao.maps.LatLng(37.577660, 126.978594)
			},
			{
					content: '<div>사직동사전투표소</div>', 
					latlng: new kakao.maps.LatLng(37.571607, 126.975372)
			},
			{
					content: '<div>삼청동사전투표소</div>', 
					latlng: new kakao.maps.LatLng(37.587715, 126.982405)
			},
			{
					content: '<div>부암동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.593657, 126.967918)
			},
			{
					content: '<div>평창동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.606991, 126.970869)
			},
			{
					content: '<div>무악동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.575904, 126.963041)
			},
			{
					content: '<div>교남동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.575478, 126.988455)
			},
			{
					content: '<div>가회동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.582990, 126.981240)
			},
			{
					content: '<div>종로1·2·3·4가동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.577966, 126.990229)
			},
			{
					content: '<div>종로5·6가동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.572656, 126.990028)
			},
			{
					content: '<div>이화동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.576533, 127.000999)
			},
			{
					content: '<div>혜화동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.583874, 127.003046)
			},
			{
					content: '<div>창신제1동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.574127, 127.014870)
			},
			{
					content: '<div>창신제2동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.575961, 127.015527)
			},
			{
					content: '<div>창신제3동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.573962, 127.015788)
			},
			{
					content: '<div>숭인제1동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.574865, 127.016105)
			},
			{
					content: '<div>숭인제2동사전투표소</div>',
					latlng: new kakao.maps.LatLng(37.573656, 127.017166)
			}
		];

		for (let i = 0; i < positions.length; i ++) {
			// 마커를 생성합니다
			let marker = new kakao.maps.Marker({
					map: map, // 마커를 표시할 지도
					position: positions[i].latlng // 마커의 위치
			});

			// 마커에 표시할 인포윈도우를 생성합니다 
			let infowindow = new kakao.maps.InfoWindow({
					content: positions[i].content // 인포윈도우에 표시할 내용
			});

			// 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
			// 이벤트 리스너로는 클로저를 만들어 등록합니다 
			// for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
			kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
			kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
		}

		// 인포윈도우를 표시하는 클로저를 만드는 함수입니다 
		function makeOverListener(map, marker, infowindow) {
			return function() {
					infowindow.open(map, marker);
			};
		}

		// 인포윈도우를 닫는 클로저를 만드는 함수입니다 
		function makeOutListener(infowindow) {
			return function() {
					infowindow.close();
			};
		}

		//----------------------------------------------------------------------------------------------------------------------------------


		//차트
		// Load the Visualization API and the corechart package.
		google.charts.load('current', {'packages':['corechart']});

		// Set a callback to run when the Google Visualization API is loaded.
		google.charts.setOnLoadCallback(drawChart);

		// 차트 그리기 함수
		function drawChart() {
			const voteResults = result();

			// 데이터 테이블 생성
			const data = new google.visualization.DataTable();
			data.addColumn('string', 'Candidate');
			data.addColumn('number', '득표 수');

			// 데이터 테이블에 행 추가
			data.addRows(voteResults);

			// 차트 옵션 설정
			const options = {
				width: 1204,
				height: 600,
				hAxis: {
						title: '득표 수',
						titleTextStyle: {
							italic: false
						}
				},
				vAxis: {
						title: '후보',
						titleTextStyle: {
							italic: false
						}
				},
				colors: ['#89a5d4']
			};

			// 차트 인스턴스화 및 그리기
			const chart = new google.visualization.BarChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}


	</script>
</body>
</html>